<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
       <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
       <!--  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" /> -->
        <title></title>
        <style type="text/css">
        html { background:#222222; }
        #game { border:solid 2px #000000; }
        
        </style>
        <script src="js/phaser.js"></script>
        <script>              
            var game = new Phaser.Game(1024, 576, Phaser.AUTO, 'brixr', { preload: preload, create: create, update: update });

            function preload() {
                game.load.atlas('breakout', 'img/breakout.png', 'js/breakout.json');
                game.load.image('starfield', 'img/starfield.jpg');
                game.load.image('paddleL', 'img/paddle.png');
                game.load.image('paddleR', 'img/paddle.png');
                game.load.image('trail', 'img/trail.png');
                game.load.image('brick_0', 'img/neon/brick0.png');
                game.load.image('brick_1', 'img/neon/brick1.png');
                game.load.image('brick_2', 'img/neon/brick2.png');
                game.load.image('brick_3', 'img/neon/brick3.png');
                game.load.image('brick_4', 'img/neon/brick4.png');
                game.load.image('brick_5', 'img/neon/brick5.png');
            }
            var spawnData = '{"spawn":[' +
                            '{"x":512,"y":480,"occupied":false},' +
                            '{"x":448,"y":448,"occupied":false},' +
                            '{"x":576,"y":448,"occupied":false},' +
                            '{"x":384,"y":416,"occupied":false},' +
                            '{"x":512,"y":416,"occupied":false},' +
                            '{"x":640,"y":416,"occupied":false},' +
                            '{"x":320,"y":384,"occupied":false},' +
                            '{"x":448,"y":384,"occupied":false},' +
                            '{"x":576,"y":384,"occupied":false},' +
                            '{"x":704,"y":384,"occupied":false},' +
                            '{"x":256,"y":352,"occupied":false},' +
                            '{"x":384,"y":352,"occupied":false},' +
                            '{"x":640,"y":352,"occupied":false},' +
                            '{"x":768,"y":352,"occupied":false},' +
                            '{"x":320,"y":320,"occupied":false},' +
                            '{"x":448,"y":320,"occupied":false},' +
                            '{"x":576,"y":320,"occupied":false},' +
                            '{"x":704,"y":320,"occupied":false},' +
                            '{"x":256,"y":288,"occupied":false},' +
                            '{"x":384,"y":288,"occupied":false},' +
                            '{"x":512,"y":288,"occupied":false},' + 
                            '{"x":640,"y":288,"occupied":false},' +
                            '{"x":768,"y":288,"occupied":false},' +
                            '{"x":320,"y":256,"occupied":false},' +
                            '{"x":448,"y":256,"occupied":false},' +
                            '{"x":576,"y":256,"occupied":false},' +
                            '{"x":704,"y":256,"occupied":false},' +
                            '{"x":256,"y":224,"occupied":false},' +
                            '{"x":384,"y":224,"occupied":false},' +
                            '{"x":512,"y":224,"occupied":false},' +
                            '{"x":640,"y":224,"occupied":false},' +
                            '{"x":768,"y":224,"occupied":false},' +
                            '{"x":320,"y":192,"occupied":false},' +
                            '{"x":448,"y":192,"occupied":false},' +
                            '{"x":576,"y":192,"occupied":false},' +
                            '{"x":704,"y":192,"occupied":false},' +
                            '{"x":384,"y":160,"occupied":false},' +
                            '{"x":512,"y":160,"occupied":false},' +
                            '{"x":640,"y":160,"occupied":false},' +
                            '{"x":448,"y":128,"occupied":false},' +
                            '{"x":576,"y":128,"occupied":false},' +
                            '{"x":512,"y":96,"occupied":false},' +
                            '{"x":512,"y":352,"occupied":false}]}';
            var spawnPoints = JSON.parse(spawnData);

            var ball;
            var paddleL;
            var paddleR;
            var lastPaddle;
            var bricks;
            var emitter;

            var ballOnpaddle = true;

            var lives = 3;

            var scoreL = 0;
            var scoreR = 0;
            var scoreCombined = scoreL + scoreR;

            var scoreLText;
            var scoreRText;
            var scoreCombinedText;
            var livesText;
            var introText;

            var s;

            function create() {

                game.physics.startSystem(Phaser.Physics.ARCADE);
                game.stage.backgroundColor = "transparent";
                game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
                game.scale.pageAlignHorizontally = true;
                game.scale.pageAlignVertically = true;


                //  We check bounds collisions against all walls other than the bottom one
                game.physics.arcade.checkCollision.left = false;
                game.physics.arcade.checkCollision.right = false;

               // s = game.add.tileSprite(0, 0, 800, 600, 'starfield');

                bricks = game.add.group();
                bricks.enableBody = true;
                bricks.physicsBodyType = Phaser.Physics.ARCADE;

                paddleL = game.add.sprite(16, game.world.centerY, 'paddleL');
                paddleL.anchor.setTo(0.5, 0.5);
                paddleR = game.add.sprite(game.width-16, game.world.centerY, 'paddleR');
                paddleR.anchor.setTo(0.5, 0.5);


                game.physics.enable(paddleL, Phaser.Physics.ARCADE);
                game.physics.enable(paddleR, Phaser.Physics.ARCADE);

                paddleL.body.collideWorldBounds = true;
                paddleL.body.bounce.set(1);
                paddleL.body.immovable = true;
                paddleR.body.collideWorldBounds = true;
                paddleR.body.bounce.set(1);
                paddleR.body.immovable = true;

                emitter = game.add.emitter(game.world.centerX, game.world.centerY, 300);
                emitter.makeParticles( [ 'trail', 'trail', 'trail' ] );
                emitter.gravity = 50;
                emitter.setAlpha(0.75, 0, 300);
                emitter.setScale(0.25, 0, 0.25, 0, 3000);
                emitter.start(false, 3000, 5);

                ball = game.add.sprite(game.world.centerX, paddleL.y - 16, 'breakout', 'ball_1.png');
                ball.anchor.set(0.5);
                ball.checkWorldBounds = true;
                game.physics.enable(ball, Phaser.Physics.ARCADE);
                ball.body.collideWorldBounds = true;
                ball.body.bounce.set(1);
                //ball.animations.add('spin', [ 'ball_1.png', 'ball_2.png', 'ball_3.png', 'ball_4.png', 'ball_5.png' ], 50, true, false);
                ball.events.onOutOfBounds.add(ballLost, this);

                

                scoreLText = game.add.text(32, 550, 'LEFT: 0', { font: "15px Impact", fill: "#ff7d00", align: "left" });
                scoreRText = game.add.text(680, 550, 'RIGHT: 0', { font: "15px Impact", fill: "#ff7d00", align: "left" });
                scoreCombinedText = game.add.text(game.world.centerX, 20, 'TEAM: 0', { font: "12px Impact", fill: "#ff7d00", align: "left" });
                livesText = game.add.text(game.world.centerX, 1, 'LIVES: 3', { font: "12px Impact", fill: "#ff7d00", align: "left" });
                introText = game.add.text(game.world.centerX, 400, '- CLICK TO START -', { font: "40px Impact", fill: "#ff7d00", align: "center" });
                introText.anchor.setTo(0.5, 0.5);

                game.input.onDown.add(releaseBall, this);

            }

            function update () {
                //  Fun, but a little sea-sick inducing :) Uncomment if you like!
                // s.tilePosition.x += (game.input.speed.y / 2);
                paddleL.y = game.input.y;
                paddleR.y = game.input.y;

                if (paddleL.y < 24) {
                    paddleL.y = 24;
                } else if (paddleL.y > game.width - 24) {
                    paddleL.y = game.width - 24;
                }

                if (ballOnpaddle) {
                    ball.body.y = paddleL.y;
                } else {
                    game.physics.arcade.collide(ball, paddleL, ballHitpaddle, null, this);
                    game.physics.arcade.collide(ball, paddleR, ballHitpaddle, null, this);
                    game.physics.arcade.collide(ball, bricks, ballHitBrick, null, this);
                }

                if(Math.floor((Math.random() * 50) + 1) == 25){
                    var brick;
                    var spawnPoint = getSpawnPoint();
                    //if(!spawnPoint.occupied){
                       // brick = bricks.create(120 + (Math.floor((Math.random() * 15) + 1) * 36), 100 + (Math.floor((Math.random() * 4) + 1) * 52), 'breakout', 'brick_' + Math.floor((Math.random() * 4) + 1) + '_1.png');
                       var brickNum = Math.floor((Math.random() * 5));
                       brick = bricks.create(spawnPoint.x, spawnPoint.y, 'brick_' + brickNum);
                       brick.anchor.x = 0.5;
                       brick.anchor.y = 0.5;
                       brick.body.bounce.set(1);
                       brick.body.immovable = true;    
                   // }
                }

                var px = ball.body.velocity.x;
                var py = ball.body.velocity.y;
                px *= -1;
                py *= -1;
                emitter.minParticleSpeed.set(px, py);
                emitter.maxParticleSpeed.set(px, py);
                emitter.emitX = ball.x;
                emitter.emitY = ball.y;

            }

            function getSpawnPoint(){
                var index = Math.floor(Math.random() * spawnPoints.spawn.length);
                var point = spawnPoints.spawn[index];
                spawnPoints.spawn[index].occupied = true;                   
                return point;
            }

            function releaseBall () {
                if (ballOnpaddle) {
                    ballOnpaddle = false;
                    ball.body.velocity.x = (ball.x < 400) ? 300 : -300;
                    ball.body.velocity.y = (ball.x < 400) ? 75 : -75;
                    ball.animations.play('spin');
                    introText.visible = false;
                }
            }

            function ballLost () {
                lives--;
                livesText.text = 'lives: ' + lives;

                if (lives === 0) {
                    gameOver();
                } else {
                    ballOnpaddle = true;
                    if(lastPaddle == 'paddleL'){
                        ball.reset(paddleL.body.x + 16, paddleL.y - 16);
                    }else{
                        ball.reset(paddleR.body.x - 16, paddleL.y - 16);
                    }
                                       
                    ball.animations.stop();
                }

            }

            function gameOver () {
                ball.body.velocity.setTo(0, 0);               
                introText.text = 'GAME OVER';
                introText.visible = true;
            }

            function ballHitBrick (_ball, _brick) {
                _brick.kill();

                //Change the ball behavior depending on which brick type was struck
                if (_brick.key == "brick_1"){
                    _ball.body.velocity.y = _ball.body.velocity.y*-1; 
                }
                if (_brick.key == "brick_2"){
                    _ball.body.velocity.y = _ball.body.velocity.y*2; 
                }
                if (_brick.key == "brick_3"){
                    _ball.body.velocity.y = _ball.body.velocity.y/2; 
                }
                if(lastPaddle == 'paddleL'){
                    scoreL += 10;   
                }
                if(lastPaddle == 'paddleR'){
                    scoreR +=10;
                }                
                scoreCombined += 10;
                
                scoreLText.text = 'P1 Score: ' + scoreL;
                scoreRText.text = 'P2 Score: ' + scoreR;
                scoreCombinedText.text = 'Score: ' + scoreCombined;

                //  Are they any bricks left?
                // if (bricks.countLiving() == 0) {
                //     //  New level starts
                //     score += 1000;
                //     scoreText.text = 'score: ' + score;
                //     introText.text = '- Next Level -';

                //     //  Let's move the ball back to the paddleL
                //     ballOnpaddle = true;
                //     ball.body.velocity.set(0);
                //     ball.x = game.world.centerX;
                //     ball.y = game.world.centerY;
                //     ball.animations.stop();

                //     //  And bring the bricks back from the dead :)
                //     bricks.callAll('revive');
                // }

            }

            function ballHitpaddle (_ball, _paddle) {
                var english = 0;
                if (_ball.y < _paddle.y) {
                    english = _paddle.y - _ball.y;
                    _ball.body.velocity.y = (-10 * english);
                } else if (_ball.y > _paddle.y) {
                    english = _ball.y -_paddle.y;
                    _ball.body.velocity.y = (10 * english);
                } else {
                    _ball.body.velocity.y = 2 + Math.random() * 8;
                }
                lastPaddle = _paddle.key;
            }

        </script>
    </head>
    <body>
        <div id="game"></div>
    </body>
</html>
